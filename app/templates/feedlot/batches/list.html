{% extends "base.html" %}

{% block title %}Batches - {{ feedlot.name }}{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row gap-6 mb-6">
    <div class="flex-1">
        <div class="mb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Batches</h1>
            <p class="text-gray-600">{{ feedlot.name }}</p>
        </div>

<!-- Search and Filter Controls -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <form method="GET" action="{{ url_for('feedlot.list_batches', feedlot_id=feedlot._id) }}">
        <div class="flex flex-col md:flex-row gap-4 items-end">
            <!-- Search Bar -->
            <div class="relative flex-1 w-full md:w-auto">
                <input type="text" name="search" value="{{ current_search }}" placeholder="Search by Batch Number or Funder..." 
                       data-testid="search-batches-input"
                       class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent outline-none transition">
                <svg class="absolute right-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            
            <!-- Event Type Filter -->
            <div class="w-full md:w-auto md:min-w-[180px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">Event Type</label>
                <select name="event_type" data-testid="filter-event-type-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent outline-none transition">
                    <option value="">All</option>
                    {% for event_type in unique_event_types %}
                    <option value="{{ event_type }}" {% if current_event_type == event_type %}selected{% endif %}>{{ event_type|title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Filter Buttons -->
            <div class="flex gap-2 w-full md:w-auto">
                <button type="submit" data-testid="apply-filters-button" class="flex-1 md:flex-none bg-teal hover:opacity-90 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <span>Apply</span>
                </button>
                <a href="{{ url_for('feedlot.list_batches', feedlot_id=feedlot._id) }}" data-testid="clear-filters-link" class="flex-1 md:flex-none text-center text-gray-600 hover:text-gray-900 font-medium py-3 px-6 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">Clear</a>
            </div>
            
            <!-- Hidden sort fields (will be set by column header clicks) -->
            <input type="hidden" name="sort_by" id="sort_by_input" value="{{ current_sort_by }}">
            <input type="hidden" name="sort_order" id="sort_order_input" value="{{ current_sort_order }}">
        </div>
    </form>
</div>

{% if batches %}
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    <button onclick="sortTable('batch_number')" data-testid="sort-batch-number-header" class="flex items-center space-x-1 hover:text-gray-700 transition-colors">
                        <span>Batch Number</span>
                        {% if current_sort_by == 'batch_number' %}
                            {% if current_sort_order == 'asc' %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
                            {% else %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            {% endif %}
                        {% endif %}
                    </button>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    <button onclick="sortTable('event_type')" data-testid="sort-event-type-header" class="flex items-center space-x-1 hover:text-gray-700 transition-colors">
                        <span>Event Type</span>
                        {% if current_sort_by == 'event_type' %}
                            {% if current_sort_order == 'asc' %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
                            {% else %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            {% endif %}
                        {% endif %}
                    </button>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    <button onclick="sortTable('event_date')" data-testid="sort-event-date-header" class="flex items-center space-x-1 hover:text-gray-700 transition-colors">
                        <span>Event Date</span>
                        {% if current_sort_by == 'event_date' %}
                            {% if current_sort_order == 'asc' %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
                            {% else %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            {% endif %}
                        {% endif %}
                    </button>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    <button onclick="sortTable('funder')" data-testid="sort-funder-header" class="flex items-center space-x-1 hover:text-gray-700 transition-colors">
                        <span>Funder</span>
                        {% if current_sort_by == 'funder' %}
                            {% if current_sort_order == 'asc' %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
                            {% else %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            {% endif %}
                        {% endif %}
                    </button>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    <button onclick="sortTable('cattle_count')" data-testid="sort-cattle-count-header" class="flex items-center space-x-1 hover:text-gray-700 transition-colors">
                        <span>Cattle Count</span>
                        {% if current_sort_by == 'cattle_count' %}
                            {% if current_sort_order == 'asc' %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
                            {% else %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            {% endif %}
                        {% endif %}
                    </button>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for batch in batches %}
            <tr class="hover:bg-gray-50" data-testid="batch-row-{{ batch._id }}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">{{ batch.batch_number }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-2 py-1 status-badge-default rounded-full text-xs font-semibold uppercase">
                        {{ batch.event_type or 'induction' }}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ batch.event_date | strftime }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ batch.funder }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-2 py-1 status-badge-default rounded-full text-xs font-semibold">
                        {{ batch.cattle_count }} cattle
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <a href="{{ url_for('feedlot.view_batch', feedlot_id=feedlot._id, batch_id=batch._id) }}" 
                       data-testid="view-batch-link-{{ batch._id }}"
                       class="text-teal hover:opacity-80 mr-3">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="bg-white rounded-lg shadow-md p-12 text-center">
    <p class="text-gray-600 text-lg mb-4">No batches found.</p>
    <a href="{{ url_for('feedlot.create_batch', feedlot_id=feedlot._id) }}" data-testid="create-first-batch-button" class="inline-block bg-teal hover:opacity-90 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
        Create Your First Batch
    </a>
</div>
{% endif %}
    </div>
    {% block actions_sidebar %}
    <div id="actions-sidebar" data-testid="batches-list-actions-sidebar" class="bg-white rounded-lg shadow-md p-4 md:min-w-[200px] md:max-w-[200px] flex-shrink-0">
        <!-- Quick Links Section -->
        <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wider">Quick Links</h3>
        <div class="space-y-1 mb-4">
            <a href="{{ url_for('feedlot.dashboard', feedlot_id=feedlot._id) }}" data-testid="quick-links-dashboard" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition-colors rounded">Dashboard</a>
            <a href="{{ url_for('top_level.feedlot_hub') }}" data-testid="quick-links-feedlot-hub" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition-colors rounded">Your Feedlots</a>
            <a href="{{ url_for('feedlot.export_manifest', feedlot_id=feedlot._id) }}" data-testid="quick-links-export-manifest" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition-colors rounded">Export Manifest</a>
        </div>
        
        <!-- Quick Actions Section -->
        <h3 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wider">Quick Actions</h3>
        <div class="space-y-1">
            {% block actions_items %}
            <a href="{{ url_for('feedlot.create_batch', feedlot_id=feedlot._id) }}" data-testid="quick-actions-create-batch" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 transition-colors rounded">Create Batch</a>
            {% endblock %}
        </div>
    </div>
    {% endblock %}
</div>

<script>
function sortTable(column) {
    const form = document.querySelector('form');
    const sortByInput = document.getElementById('sort_by_input');
    const sortOrderInput = document.getElementById('sort_order_input');
    const currentSortBy = sortByInput.value;
    const currentSortOrder = sortOrderInput.value;
    
    // If clicking the same column, toggle sort order
    if (currentSortBy === column) {
        sortOrderInput.value = currentSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        // If clicking a different column, set to ascending by default
        sortByInput.value = column;
        sortOrderInput.value = 'asc';
    }
    
    // Submit the form
    form.submit();
}
</script>
{% endblock %}

